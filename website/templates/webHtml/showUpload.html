<!DOCTYPE html>
<html lang="en">
{% include "public/header.html" %}
<style>
    .page-header {
        margin: 20px 0px 20px;
    }
    #page-wrapper {
        position: inherit;
        margin: 0 0 0 154px;
        padding: 0 30px;
        border-left: 1px solid #e7e7e7;
  }
    body{
        font-size: 12px;
    }
    .hid{
        display: none;
    }
    .hidurl{
        display: none;
    }
</style>
<body>
    <div id="wrapper">
        {% include "public/nav.html" %}
        <div id="page-wrapper">
            <div class="row">
                <div class="col-lg-12">
                    <h4 class="page-header">頁面說明</h4>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-12">
                    <div class="panel-body" id = 'DTable'>
                        <table>
                            <tr>
                                <td>
                                    <input  style="width: 100px" type="button"  class="btn btn-success" value="添加" onclick="addBody()">
                                </td>
                                <td>
                                    &nbsp;&nbsp;
                                </td>
                                <td>
                                    <input  style="width: 100px" type="button"  class="btn btn-success" value="獲取當前頁" onclick="getPage()">
                                </td>
                                <td>
                                    &nbsp;&nbsp;
                                </td>
                                <td>
                                    <input  style="width: 100px" type="button"  class="btn btn-danger" value="選擇刪除" onclick="deleteBodys()">
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% include "public/foot.html" %}
    <script>
    /*網頁打開,生成表格,ajax異步加載數據*/
    $(document).ready(function() {
        $.ajax({
            url: "../getAllData/",
            type: "get",
            dataType: "json",
            success: function (res){
                if(res.status){
                    tableHtml = "<table width='100%' class='table table-striped table-bordered table-hover' id='dataTables-example'>" +
                    "<thead align='center'>"+
                    "<tr>"+
                    "<td>"+"<input type='checkbox' name='user' id='user' onclick='qsel(this)'>"+"</td>"+
                    "<td>"+'ID'+"</td>"+
                    "<td>"+'員工姓名'+"</td>"+
                    "<td>"+'工號'+"</td>"+
                    "<td>"+'員工名'+"</td>"+
                    "<td>"+'員工姓'+"</td>"+
                    "<td>"+'員工部門'+"</td>"+
                    "<td>"+'添加時間'+"</td>"+
                    "<td>"+'添加人'+"</td>"+
                    "</tr>"+
                    "</thead>"+
                    "<tbody align='center'>";
                    for (var i = 0; i < res.message.length; i++) {
                        tableHtml = tableHtml +
                                    "<tr>" +
                                    "<td align='center'>" + "<input type='checkbox' name='userlist'>" + "</td>";
                                    for(j=0;j<res.message[i].length;j++){
                                        tableHtml = tableHtml + "<td>" + res.message[i][j] + "</td>"
                                    }
                        tableHtml = tableHtml + "</tr>";
                    }
                    tableHtml = tableHtml + "</tbody>" + "</table>";
                    $("#DTable").append(tableHtml);
                    /*將樣式封裝進方法中，直接調用*/
                    putCss();
                    /*將表內修改添加進表格中*/
                    clickChange();
                }else{
                    layer.msg(data.message, {icon: 2});
                }
            }
        });
    });

    <!--表格樣式修改-->
    function putCss(){
        //對表格樣式進行操作
        $('#dataTables-example').DataTable({
            // bInfo:false,     //啟用或禁用表格信息顯示
            // bPaginate:false, //啟用或禁用分頁
            // bFilter:false,//啟用或禁用搜索功能
            responsive: true,
            iDisplayLength:100,//設置每頁顯示的數據條數
            // bLengthChange:false,//允許最終用戶從選擇菜單中選擇格式化頁面的大小
            bSort:false,     //啟用或禁用列的排序
            // sScrollX:'100%',//啟用水平滾動,啟用滾輪會默認不分頁
            sScrollY:'300px',//啟用垂直滾動，啟用滾動會默認不分頁
            bProcessing:true,//使用分頁時在單個頁面上顯示的行數
            bAutoWidth:false,//啟用或禁用自動列寬計算
            // aaSorting:[
            //    [1,"asc"]
            // ],           //啟用排序時,按照指定列排序
            lengthMenu:[100,200,500],//設置格式化頁面的大小
            oLanguage:{
               sLengthMenu:'每頁顯示_MENU_條記錄',
               sZeroRecords:'抱歉，沒有找到',
               sInfo:'從_START_到_END_/共_TOTAL_條數據',
               sInfoEmpty:'沒有數據',
               sInfoFiltered:"(從_MAX_條數據中檢索)",
               oPaginate:{
                   sFirst:'首頁',
                   sPrevious:'前一頁',
                   sNext:'後一頁',
                   sLast:'尾頁'
               },
               sZeroRecords:'沒有檢索到數據'
           }              //國際化
        });
    }

    <!--添加一欄位-->
    function addBody(){
        var trHtml = '';
        trHtml = trHtml +
        "<tr id='foot'>"+
        "<td align='center'>" + "<input type='checkbox' name='userlist'>" + "</td>"+
        "<td>"+"<input type='text' style='border: none;width:100%' disabled>"+"</td>"+ //disabled保證此欄不被選擇，因為ID為自增長
        "<td>"+"<input type='text' style='border: none;width:100%' onblur='addOneRow(this)'>"+"</td>"+
        "<td>"+"<input type='text' style='border: none;width:100%' onblur='addOneRow(this)'>"+"</td>"+
        "<td>"+"<input type='text' style='border: none;width:100%' onblur='addOneRow(this)'>"+"</td>"+
        "<td>"+"<input type='text' style='border: none;width:100%' onblur='addOneRow(this)'>"+"</td>"+
        "<td>"+"<input type='text' style='border: none;width:100%' onblur='addOneRow(this)'>"+"</td>"+
        "<td>"+"<input type='text' style='border: none;width:100%' onblur='addOneRow(this)'>"+"</td>"+
        "<td>"+"<input type='text' style='border: none;width:100%' onblur='addOneRow(this)'>"+"</td>"+
        "</tr>";
        $("#dataTables-example").find('tbody').append(trHtml);
        /*定位到新添加的欄位*/
        document.getElementById('foot').scrollIntoView();
    }

    <!--對要添加的一欄進行操作-->
    function addOneRow(obj){
        var len = $(obj).parent().parent().find('input').length;
        var data = [];
        for(i = 2;i < len; i++){
            var val = $(obj).parent().parent().find('input')[i].value.trim();
            data.push(val);
        }
        if(data[0] == ""){
            layer.msg('員工姓名不能為空！', {icon: 2});
        }else if(data[1] == ""){
            layer.msg('員工工號不能為空！', {icon: 2});
        }else if(data[4] == ""){
            layer.msg('員工部門不能為空！', {icon: 2});
        }else if(data[6] == ""){
            layer.msg('添加人不能為空！', {icon: 2});
        }else{
            layer.confirm('確認添加？',function(index) {
                var json1 = JSON.stringify(data);
                $.ajax({
                    url:"../addOneData/",
                    data:{data1:json1},
                    type:"POST",
                    dataType:"json",
                    cache:false,
                    success : function(data) {
                       if(data.status){
                           layer.msg(data.message,{icon:1});
                           setTimeout(
                               function(){
                                  location.href = "{% url 'html:showHtml'%}"
                               },2000
                           )
                       }else{
                           layer.msg(data.message, {icon: 2});
                       }
                    }
                });
            })
        }
    }

<!--表內單列修改-->
    function clickChange(){
        $("#dataTables-example td:nth-child(4)").click(function(){
            var citrixID = $(this).parents('tr').find('td')[1].innerText;
            $(this).editable({
                type:"text",
                title:$(this).text(),
                disabled:false,
                emptytext:"空文本",
                mode:"inline",
                validate:function(value){
                    if(!$.trim(value)){
                        return '不能為空！';
                    }else{
                        $.ajax({
                            url:"../updateOneData/",
                            data:{citrixID:citrixID,value:value},
                            type:"POST",
                            dataType:"json",
                            cache:false,
                            success : function(data) {
                                if(!data.status){
                                    layer.msg(data.message,{icon:2});
                                }
                            }
                        });
                    }
                }
            })
        });
    }

    /*表內全欄位修改*/
    /*$("#dataTables-example tbody td").click(function(){
            $(this).editable({
                type:"text",
                title:$(this).text(),
                disabled:false,
                emptytext:"空文本",
                mode:"inline",
                validate:function(value){
                    if(!$.trim(value)){
                        return '不能為空！';
                    }
                }
            })
      });*/

<!-- 全選操作 -->
    function qsel(obj){
        var sta = obj.checked;
        var arr=document.getElementsByName("userlist");
        for(var i= 0;i<arr.length;i++){
            arr[i].checked=sta;
        }
    }

<!--通過選中進行操作-->
    function deleteBodys(){
        layer.confirm('確認刪除？',function(index) {
            var idList = [];
            $('input[name="userlist"]:checked').each(function(){
                var tr = this.parentNode.parentNode;
                var tds = tr.cells;
                idList.push(tds[1].innerHTML);
            });
            idList = JSON.stringify(idList);
            $.ajax({
                url:"../deleteData/",
                data:{idList:idList},
                type:"POST",
                dataType:"json",
                cache:false,
                success : function(data) {
                   if(data.status){
                       layer.msg(data.message,{icon:1});
                       setTimeout(
                           function(){
                              location.href = "{% url 'html:showHtml'%}"
                           },2000
                       )
                   }else{
                       layer.msg(data.message, {icon: 2});
                   }
                }
            });
        });
        /*得到被選中的欄位的所有信息*/
        /*var datas = [];
        $('input[name="userlist"]:checked').each(function () {
            var tr = this.parentNode.parentNode;
            var tds = tr.cells;
            var data =[];
            for(var i =1;i<tds.length-1;i++){
                data.push(tds[i].innerHTML);
            }
            datas.push(data);
        });
        alert(datas);*/
    }

    <!--獲取當前頁面上表格內的所有數據-->
    function getPage(){
        var tab = document.getElementById("dataTables-example");
        var rows = tab.rows;
        var list1 = [];
        for(var i =1;i<rows.length;i++){
            var list2=[];
            for(var j=1;j<rows[i].cells.length-1;j++){
                var cell = rows[i].cells[j];
                list2.push(cell.innerHTML);
            }
            list1.push(list2);
        }
        var json1 = JSON.stringify(list1);
        alert(json1);
    }
    </script>
</body>

</html>
